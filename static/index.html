<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>cache</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Azeret+Mono:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
/*
  :root {
    --bg: #0f0f0d;
    --surface: #1a1a17;
    --border: #2e2e28;
    --accent: #c8b560;
    --accent-dim: #8a7a3a;
    --text: #e8e4d4;
    --text-dim: #7a7668;
    --danger: #c85a4a;
    --success: #5a9a6a;
    --mono: 'Azeret Mono', monospace;
    --serif: 'DM Serif Display', serif;
  }
*/
  :root {
    --bg:         #f5f0e8;   /* papel crema */
    --surface:    #ede7d9;   /* superficie ligeramente más oscura */
    --border:     #c8bfa8;   /* borde cálido */
    --accent:     #8a6a20;   /* dorado oscuro, legible sobre claro */
    --accent-dim: #b08a3a;   /* dorado medio */
    --text:       #1a1812;   /* casi negro cálido */
    --text-dim:   #7a6e58;   /* gris tostado */
    --danger:     #a03020;
    --success:    #3a7a48;
  }


  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    min-height: 100vh;
    display: grid;
    grid-template-rows: auto 1fr;
  }

  header {
    border-bottom: 1px solid var(--border);
    padding: 18px 32px;
    display: flex;
    align-items: center;
    gap: 24px;
  }

  header h1 {
    font-family: var(--serif);
    font-size: 26px;
    color: var(--accent);
    letter-spacing: 0.02em;
    font-weight: 400;
  }

  header h1 span {
    color: var(--text-dim);
    font-family: var(--mono);
    font-size: 11px;
    margin-left: 8px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .tabs {
    margin-left: auto;
    display: flex;
    gap: 2px;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 3px;
    border-radius: 4px;
  }

  .tab {
    padding: 5px 16px;
    cursor: pointer;
    border-radius: 2px;
    color: var(--text-dim);
    transition: all 0.15s;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-size: 11px;
  }

  .tab.active {
    background: var(--accent);
    color: var(--bg);
    font-weight: 600;
  }

  .tab:not(.active):hover { color: var(--text); }

  main {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 0;
    overflow: hidden;
    height: calc(100vh - 65px);
  }

  /* LEFT PANEL */
  .panel {
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    padding: 16px 20px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-wrap {
    flex: 1;
    position: relative;
  }

  .search-wrap input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    padding: 6px 10px 6px 28px;
    border-radius: 3px;
    outline: none;
    transition: border-color 0.15s;
  }

  .search-wrap input:focus { border-color: var(--accent-dim); }
  .search-wrap input::placeholder { color: var(--text-dim); }

  .search-icon {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    font-size: 12px;
  }

  .btn-new {
    background: var(--accent);
    color: var(--bg);
    border: none;
    font-family: var(--mono);
    font-size: 18px;
    font-weight: 300;
    width: 28px;
    height: 28px;
    border-radius: 3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.15s;
    line-height: 1;
    padding-bottom: 1px;
  }

  .btn-new:hover { opacity: 0.85; }

  .list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
  }

  .list::-webkit-scrollbar { width: 4px; }
  .list::-webkit-scrollbar-track { background: transparent; }
  .list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .list-item {
    padding: 9px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    border-left: 2px solid transparent;
    transition: all 0.1s;
  }

  .list-item:hover { background: var(--surface); }
  .list-item.active {
    background: var(--surface);
    border-left-color: var(--accent);
  }

  .list-item-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .list-item-meta {
    color: var(--text-dim);
    font-size: 11px;
    flex-shrink: 0;
  }

  .list-empty {
    padding: 32px 20px;
    color: var(--text-dim);
    text-align: center;
    font-size: 12px;
  }

  /* RIGHT PANEL - DETAIL */
  .detail {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  .detail-empty {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dim);
    font-size: 12px;
    letter-spacing: 0.1em;
  }

  .detail-content {
    padding: 32px 40px;
    max-width: 640px;
  }

  .detail-top {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 32px;
  }

  .detail-title {
    font-family: var(--serif);
    font-size: 32px;
    font-weight: 400;
    color: var(--text);
    flex: 1;
    line-height: 1.1;
  }

  .detail-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
    padding-top: 6px;
  }

  .btn {
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 3px;
    cursor: pointer;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: all 0.15s;
  }

  .btn:hover { border-color: var(--text-dim); color: var(--text); }
  .btn.danger:hover { border-color: var(--danger); color: var(--danger); }
  .btn.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
    font-weight: 600;
  }
  .btn.primary:hover { opacity: 0.85; }

  .detail-fields {
    display: grid;
    gap: 16px;
    margin-bottom: 32px;
  }

  .field {
    display: grid;
    grid-template-columns: 130px 1fr;
    gap: 12px;
    align-items: center;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .field:last-child { border-bottom: none; }

  .field-label {
    color: var(--text-dim);
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .field-value { color: var(--text); }

  .field-value.muted { color: var(--text-dim); font-size: 12px; }

  .loc-link {
    color: var(--accent);
    cursor: pointer;
    text-decoration: none;
    border-bottom: 1px solid var(--accent-dim);
    transition: border-color 0.15s, color 0.15s;
  }
  .loc-link:hover { color: var(--text); border-bottom-color: var(--text-dim); }

  /* FORM */
  .form-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  .form-overlay.visible {
    opacity: 1;
    pointer-events: all;
  }

  .form-box {
    background: var(--surface);
    border: 1px solid var(--border);
    width: 420px;
    border-radius: 4px;
    overflow: hidden;
    transform: translateY(8px);
    transition: transform 0.2s;
  }

  .form-overlay.visible .form-box { transform: translateY(0); }

  .form-header {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .form-title {
    font-family: var(--serif);
    font-size: 18px;
    font-weight: 400;
    color: var(--accent);
  }

  .form-close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 2px;
  }

  .form-close:hover { color: var(--text); }

  .form-body { padding: 24px; display: grid; gap: 16px; }

  .form-group { display: grid; gap: 6px; }

  .form-label {
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
  }

  .form-input, .form-select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    padding: 9px 12px;
    border-radius: 3px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }

  .form-input:focus, .form-select:focus { border-color: var(--accent-dim); }
  .form-select option { background: var(--surface); }

  .form-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  /* location tree indent */
  .list-item[data-depth="1"] { padding-left: 32px; }
  .list-item[data-depth="2"] { padding-left: 44px; }
  .list-item[data-depth="3"] { padding-left: 56px; }

  .tree-toggle {
    color: var(--text-dim);
    font-size: 9px;
    flex-shrink: 0;
    cursor: pointer;
    padding: 2px 4px;
    transition: transform 0.15s, color 0.15s;
    display: inline-block;
    user-select: none;
  }
  .tree-toggle:hover { color: var(--accent); }
  .tree-toggle.open { transform: rotate(90deg); }
  .tree-toggle-spacer { display: inline-block; width: 17px; flex-shrink: 0; }

  .list-item-path {
    display: block;
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 1px;
  }

  .quick-create {
    display: flex;
    gap: 8px;
    margin-bottom: 28px;
  }

  /* items in location */
  .items-section { margin-top: 32px; }
  .section-title {
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 12px;
  }

  .item-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 4px 10px;
    border-radius: 2px;
    margin: 0 4px 4px 0;
    cursor: pointer;
    font-size: 12px;
    transition: border-color 0.15s;
  }

  .item-chip:hover { border-color: var(--accent-dim); color: var(--accent); }

  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 10px 16px;
    border-radius: 3px;
    font-size: 12px;
    z-index: 200;
    transform: translateY(8px);
    opacity: 0;
    transition: all 0.2s;
    pointer-events: none;
  }

  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { border-color: var(--danger); color: var(--danger); }

  /* ── Mobile ────────────────────────────────────────────────────────────── */
  .btn-back {
    display: none;
    background: none;
    border: none;
    color: var(--accent);
    font-family: var(--mono);
    font-size: 12px;
    cursor: pointer;
    padding: 0;
    letter-spacing: 0.05em;
  }

  @media (max-width: 640px) {
    header { padding: 14px 16px; }
    header h1 { font-size: 20px; }

    main {
      display: block;
      height: calc(100vh - 57px);
      position: relative;
      overflow: hidden;
    }

    .panel {
      position: absolute;
      inset: 0;
      border-right: none;
      transition: transform 0.25s ease;
    }

    .detail {
      position: absolute;
      inset: 0;
      transform: translateX(100%);
      transition: transform 0.25s ease;
      background: var(--bg);
    }

    /* When detail is active, slide panel out and detail in */
    main.detail-open .panel  { transform: translateX(-100%); }
    main.detail-open .detail { transform: translateX(0); }

    .detail-content { padding: 20px 16px; }

    .btn-back { display: inline-flex; align-items: center; gap: 4px; margin-bottom: 20px; }

    .detail-title { font-size: 24px; }

    .field { grid-template-columns: 100px 1fr; }

    .quick-create { flex-wrap: wrap; }
  }
</style>
</head>
<body>

<header>
  <h1>cache <span>inventory</span></h1>
  <div class="tabs">
    <div class="tab active" data-tab="locations">Locations</div>
    <div class="tab" data-tab="items">Items</div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="panel-header">
      <div class="search-wrap">
        <span class="search-icon">⌕</span>
        <input type="text" id="search" placeholder="search…" autocomplete="off">
      </div>
      <button class="btn-new" id="btn-new" title="New">+</button>
    </div>
    <div class="list" id="list"></div>
  </div>

  <div class="detail" id="detail">
    <div class="detail-empty">← select an entry</div>
  </div>
</main>

<!-- Form overlay -->
<div class="form-overlay" id="form-overlay">
  <div class="form-box">
    <div class="form-header">
      <span class="form-title" id="form-title">New location</span>
      <button class="form-close" id="form-close">✕</button>
    </div>
    <div class="form-body" id="form-body"></div>
    <div class="form-footer">
      <button class="btn" id="form-cancel">Cancel</button>
      <button class="btn primary" id="form-submit">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '';  // same origin

// ── State ──────────────────────────────────────────────────────────────────
let currentTab = 'locations';
let locations = [];
let items = [];
let selected = null;
let formMode = null;   // { action: 'create'|'edit', entity, data?, defaultLocationId? }
let searchTimer = null;
let expandedIds = new Set(); // ids of expanded location nodes

// ── Helpers ────────────────────────────────────────────────────────────────
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  if (!res.ok) throw new Error(await res.text());
  if (res.status === 204) return null;
  return res.json();
}

function toast(msg, error = false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show' + (error ? ' error' : '');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.className = 'toast', 2500);
}

function fmtDate(iso) {
  return new Date(iso).toLocaleString('en-GB', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });
}

// ── Data loading ───────────────────────────────────────────────────────────
async function loadLocations(q = '') {
  locations = await api('GET', '/locations' + (q ? `?q=${encodeURIComponent(q)}` : ''));
  renderList();
}

async function loadItems(q = '') {
  items = await api('GET', '/items' + (q ? `?q=${encodeURIComponent(q)}` : ''));
  renderList();
}

function load(q = '') {
  if (currentTab === 'locations') loadLocations(q);
  else loadItems(q);
}

// ── Location tree ──────────────────────────────────────────────────────────
function buildTree(locs) {
  const map = {};
  locs.forEach(l => map[l.id] = { ...l, children: [] });
  const roots = [];
  locs.forEach(l => {
    if (l.parent_id && map[l.parent_id]) map[l.parent_id].children.push(map[l.id]);
    else roots.push(map[l.id]);
  });
  return { map, roots };
}

// Flatten only visible nodes (roots + children of expanded nodes)
function flattenVisible(roots, map) {
  const flat = [];
  function walk(node, depth) {
    const hasChildren = node.children.length > 0;
    flat.push({ ...node, depth, hasChildren });
    if (hasChildren && expandedIds.has(node.id)) {
      node.children.forEach(c => walk(map[c.id], depth + 1));
    }
  }
  roots.forEach(r => walk(r, 0));
  return flat;
}

// ── Render list ────────────────────────────────────────────────────────────
function renderList() {
  const el = document.getElementById('list');
  const q = document.getElementById('search').value;

  if (currentTab === 'locations') {
    if (!locations.length) { el.innerHTML = '<div class="list-empty">no locations</div>'; return; }

    let data;
    if (q) {
      // Searching: show flat results with full path as subtitle
      data = locations.map(l => ({ ...l, depth: 0, hasChildren: false, searchPath: locationPath(l.id) }));
    } else {
      const { map, roots } = buildTree(locations);
      data = flattenVisible(roots, map);
    }

    if (!data.length) { el.innerHTML = '<div class="list-empty">no locations</div>'; return; }

    el.innerHTML = data.map(loc => {
      const isExpanded = expandedIds.has(loc.id);
      const toggle = loc.hasChildren
        ? `<span class="tree-toggle${isExpanded ? ' open' : ''}" data-toggle-id="${loc.id}">▶</span>`
        : `<span class="tree-toggle-spacer"></span>`;
      const subtitle = q && loc.searchPath
        ? `<span class="list-item-path">${esc(loc.searchPath)}</span>`
        : '';
      return `<div class="list-item${selected?.id === loc.id ? ' active' : ''}"
                   data-id="${loc.id}" data-depth="${loc.depth || 0}">
        ${toggle}
        <span class="list-item-name">${esc(loc.name)}${subtitle}</span>
      </div>`;
    }).join('');

    // Toggle expand/collapse
    el.querySelectorAll('.tree-toggle').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = parseInt(btn.dataset.toggleId);
        if (expandedIds.has(id)) {
          // Collapse this node and all its descendants
          const toCollapse = new Set([id]);
          let changed = true;
          while (changed) {
            changed = false;
            locations.forEach(l => {
              if (!toCollapse.has(l.id) && toCollapse.has(l.parent_id)) {
                toCollapse.add(l.id);
                changed = true;
              }
            });
          }
          toCollapse.forEach(cid => expandedIds.delete(cid));
        } else {
          expandedIds.add(id);
        }
        renderList();
      });
    });

  } else {
    if (!items.length) { el.innerHTML = '<div class="list-empty">no items</div>'; return; }
    el.innerHTML = items.map(item => {
      const loc = locations.find(l => l.id === item.location_id);
      return `<div class="list-item${selected?.id === item.id ? ' active' : ''}" data-id="${item.id}">
        <span class="list-item-name">${esc(item.name)}</span>
        <span class="list-item-meta">${loc ? esc(loc.name) : ''}</span>
      </div>`;
    }).join('');
  }

  el.querySelectorAll('.list-item').forEach(row => {
    row.addEventListener('click', () => selectItem(parseInt(row.dataset.id)));
  });
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Returns "Root › Child › Grandchild" for a given location id
function locationPath(id) {
  const parts = [];
  let current = locations.find(l => l.id === id);
  while (current) {
    parts.unshift(current.name);
    current = current.parent_id ? locations.find(l => l.id === current.parent_id) : null;
  }
  return parts.join(' › ');
}

// Returns flat list sorted by full path, excluding a node and all its descendants
function locationOptionsFor(excludeId = null) {
  const excluded = new Set();
  if (excludeId != null) {
    excluded.add(excludeId);
    let changed = true;
    while (changed) {
      changed = false;
      locations.forEach(l => {
        if (!excluded.has(l.id) && excluded.has(l.parent_id)) {
          excluded.add(l.id);
          changed = true;
        }
      });
    }
  }
  return locations
    .filter(l => !excluded.has(l.id))
    .map(l => ({ id: l.id, path: locationPath(l.id) }))
    .sort((a, b) => a.path.localeCompare(b.path));
}

// ── Detail view ────────────────────────────────────────────────────────────
function openDetailPanel() {
  document.querySelector('main').classList.add('detail-open');
}

function closeDetailPanel() {
  document.querySelector('main').classList.remove('detail-open');
}

async function selectItem(id) {
  if (currentTab === 'locations') {
    selected = locations.find(l => l.id === id);
    if (!selected) return;
    // Expand this node and all its ancestors so it's visible in the tree
    let cur = selected;
    while (cur) {
      expandedIds.add(cur.id);
      cur = cur.parent_id ? locations.find(l => l.id === cur.parent_id) : null;
    }
    renderDetail();
    openDetailPanel();
    const locItems = await api('GET', `/items?location_id=${id}`);
    renderDetail(locItems);
  } else {
    selected = items.find(i => i.id === id);
    if (!selected) return;
    renderDetail();
    openDetailPanel();
  }
  renderList();
}

function renderDetail(locItems = null) {
  const el = document.getElementById('detail');
  if (!selected) { el.innerHTML = '<div class="detail-empty">← select an entry</div>'; return; }

  if (currentTab === 'locations') {
    const parent = locations.find(l => l.id === selected.parent_id);
    const itemsHtml = locItems === null
      ? ''
      : locItems.length === 0
        ? '<p style="color:var(--text-dim);font-size:12px">No items here.</p>'
        : locItems.map(i => `<span class="item-chip" data-item-id="${i.id}">◈ ${esc(i.name)}</span>`).join('');

    el.innerHTML = `<div class="detail-content">
      <button class="btn-back" id="d-back">← back</button>
      <div class="detail-top">
        <div class="detail-title">${esc(selected.name)}</div>
        <div class="detail-actions">
          <button class="btn" id="d-edit">Edit</button>
          <button class="btn danger" id="d-delete">Delete</button>
        </div>
      </div>
      <div class="detail-fields">
        <div class="field">
          <span class="field-label">Parent</span>
          <span class="field-value">${parent ? `<a class="loc-link" data-loc-id="${parent.id}">${esc(locationPath(parent.id))}</a>` : '<span class="muted">— root</span>'}</span>
        </div>
        <div class="field">
          <span class="field-label">Created</span>
          <span class="field-value muted">${fmtDate(selected.created_at)}</span>
        </div>
        <div class="field">
          <span class="field-label">Updated</span>
          <span class="field-value muted">${fmtDate(selected.updated_at)}</span>
        </div>
      </div>
      <div class="quick-create">
        <button class="btn" id="d-new-location">+ Sub-location here</button>
        <button class="btn" id="d-new-item">+ Item here</button>
      </div>
      ${locItems !== null ? `<div class="items-section">
        <div class="section-title">Items here</div>
        <div id="loc-items">${itemsHtml}</div>
      </div>` : ''}
    </div>`;

    el.querySelector('#d-edit').addEventListener('click', () => openForm('edit'));
    el.querySelector('#d-delete').addEventListener('click', deleteSelected);
    el.querySelector('#d-new-location').addEventListener('click', () => openForm('create', 'location', selected.id));
    el.querySelector('#d-new-item').addEventListener('click', () => openForm('create', 'item', selected.id));
    el.querySelectorAll('.loc-link').forEach(a => {
      a.addEventListener('click', () => selectItem(parseInt(a.dataset.locId)));
    });
    el.querySelectorAll('.item-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        currentTab = 'items';
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'items'));
        load();
        setTimeout(() => selectItem(parseInt(chip.dataset.itemId)), 100);
      });
    });
  } else {
    const loc = locations.find(l => l.id === selected.location_id);
    el.innerHTML = `<div class="detail-content">
      <button class="btn-back" id="d-back">← back</button>
      <div class="detail-top">
        <div class="detail-title">${esc(selected.name)}</div>
        <div class="detail-actions">
          <button class="btn" id="d-edit">Edit</button>
          <button class="btn danger" id="d-delete">Delete</button>
        </div>
      </div>
      <div class="detail-fields">
        <div class="field">
          <span class="field-label">Location</span>
          <span class="field-value">${loc ? `<a class="loc-link" data-loc-id="${loc.id}">${esc(locationPath(loc.id))}</a>` : '—'}</span>
        </div>
        <div class="field">
          <span class="field-label">Created</span>
          <span class="field-value muted">${fmtDate(selected.created_at)}</span>
        </div>
        <div class="field">
          <span class="field-label">Updated</span>
          <span class="field-value muted">${fmtDate(selected.updated_at)}</span>
        </div>
      </div>
    </div>`;

    el.querySelector('#d-edit').addEventListener('click', () => openForm('edit'));
    el.querySelector('#d-delete').addEventListener('click', deleteSelected);
    el.querySelectorAll('.loc-link').forEach(a => {
      a.addEventListener('click', () => {
        // Switch to locations tab and navigate to that location
        currentTab = 'locations';
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'locations'));
        selected = null;
        selectItem(parseInt(a.dataset.locId));
      });
    });
  }

  // Back button (visible only on mobile via CSS)
  const backBtn = el.querySelector('#d-back');
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      selected = null;
      closeDetailPanel();
      renderList();
    });
  }
}

// ── Forms ──────────────────────────────────────────────────────────────────
function openForm(action, entityOverride = null, defaultLocationId = null) {
  const entity = entityOverride || (currentTab === 'locations' ? 'location' : 'item');
  formMode = { action, entity, defaultLocationId };
  const overlay = document.getElementById('form-overlay');
  const title = document.getElementById('form-title');
  const body = document.getElementById('form-body');

  const isEdit = action === 'edit';
  title.textContent = `${isEdit ? 'Edit' : 'New'} ${formMode.entity}`;

  if (formMode.entity === 'location') {
    // When creating with defaultLocationId, pre-select it as parent
    const preParent = isEdit ? selected?.parent_id : defaultLocationId;
    const parentOptions = locationOptionsFor(isEdit ? selected?.id : null)
      .map(o => `<option value="${o.id}"${preParent === o.id ? ' selected' : ''}>${esc(o.path)}</option>`)
      .join('');

    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" id="f-name" type="text" value="${isEdit ? esc(selected.name) : ''}" placeholder="e.g. Living Room">
      </div>
      <div class="form-group">
        <label class="form-label">Parent location</label>
        <select class="form-select" id="f-parent">
          <option value="">— none (root)</option>
          ${parentOptions}
        </select>
      </div>`;
  } else {
    const preLocation = isEdit ? selected?.location_id : defaultLocationId;
    const locOptions = locationOptionsFor()
      .map(o => `<option value="${o.id}"${preLocation === o.id ? ' selected' : ''}>${esc(o.path)}</option>`)
      .join('');

    body.innerHTML = `
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" id="f-name" type="text" value="${isEdit ? esc(selected.name) : ''}" placeholder="e.g. HDMI cable">
      </div>
      <div class="form-group">
        <label class="form-label">Location</label>
        <select class="form-select" id="f-location">
          <option value="">— select —</option>
          ${locOptions}
        </select>
      </div>`;
  }

  overlay.classList.add('visible');
  document.getElementById('f-name').focus();
}

function closeForm() {
  document.getElementById('form-overlay').classList.remove('visible');
  formMode = null;
}

async function submitForm() {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { toast('Name is required', true); return; }

  // Remember which location was selected before submit (for quick-create flow)
  const returnToLocation = formMode.action === 'create' && formMode.defaultLocationId
    ? formMode.defaultLocationId
    : null;

  try {
    if (formMode.entity === 'location') {
      const parentVal = document.getElementById('f-parent').value;
      const body = { name, parent_id: parentVal ? parseInt(parentVal) : null };
      if (formMode.action === 'create') {
        await api('POST', '/locations', body);
        toast('Location created');
      } else {
        await api('PUT', `/locations/${selected.id}`, body);
        toast('Location updated');
      }
      await loadLocations(document.getElementById('search').value);
    } else {
      const locVal = document.getElementById('f-location').value;
      if (!locVal) { toast('Location is required', true); return; }
      const body = { name, location_id: parseInt(locVal) };
      if (formMode.action === 'create') {
        await api('POST', '/items', body);
        toast('Item created');
      } else {
        await api('PUT', `/items/${selected.id}`, body);
        toast('Item updated');
      }
      await loadItems(document.getElementById('search').value);
    }
    closeForm();

    if (returnToLocation) {
      // Go back to the parent location view
      currentTab = 'locations';
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === 'locations'));
      await loadLocations();
      await loadItems();
      await selectItem(returnToLocation);
    } else {
      selected = null;
      renderDetail();
    }
  } catch (e) {
    toast(e.message, true);
  }
}

async function deleteSelected() {
  if (!selected) return;
  const label = currentTab === 'locations' ? 'location' : 'item';
  if (!confirm(`Delete "${selected.name}"?`)) return;
  try {
    if (currentTab === 'locations') {
      await api('DELETE', `/locations/${selected.id}`);
      await loadLocations();
    } else {
      await api('DELETE', `/items/${selected.id}`);
      await loadItems();
    }
    selected = null;
    renderDetail();
    toast('Deleted');
  } catch (e) {
    toast(e.message, true);
  }
}

// ── Events ─────────────────────────────────────────────────────────────────
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    currentTab = tab.dataset.tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === currentTab));
    selected = null;
    document.getElementById('search').value = '';
    closeDetailPanel();
    renderDetail();
    load();
  });
});

document.getElementById('btn-new').addEventListener('click', () => openForm('create'));
document.getElementById('form-close').addEventListener('click', closeForm);
document.getElementById('form-cancel').addEventListener('click', closeForm);
document.getElementById('form-submit').addEventListener('click', submitForm);
document.getElementById('form-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeForm();
});

document.getElementById('search').addEventListener('input', e => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => load(e.target.value.trim()), 250);
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeForm();
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    document.getElementById('search').focus();
    e.preventDefault();
  }
});

// ── Init ───────────────────────────────────────────────────────────────────
(async () => {
  await loadLocations();
  await loadItems(); // pre-load for lookups
  // reload items list if starting on items tab
  if (currentTab === 'items') renderList();
})();
</script>
</body>
</html>
